{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprar Tickets - {{ rifa.titulo }}</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="shortcut icon" href="{% static 'images/logo-img.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="purchase-page">
    <!-- Header -->
    <header class="header">
        <nav class="nav-menu-compra"> 
            <div class="nav-actions">
                <a href="{% url 'index' %}" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                  
                </a>
            </div>  
            <h1 class="purchase-title">{{ rifa.titulo }}</h1>
        </nav>
    </header>

    <!-- Purchase Container -->
    <div class="purchase-container">
        <form method="post" enctype="multipart/form-data" class="purchase-form">
            {% csrf_token %}
            <input type="hidden" name="rifa_id" value="{{ rifa.id }}">

            <!-- Raffle Info Section -->
            <div class="purchase-section">
                <div class="raffle-info-header">
                    <div class="raffle-info-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <span class="info-label">Juega el</span>
                            <span class="info-value">{{ rifa.fecha_sorteo|date:"d M Y" }}</span>
                        </div>
                    </div>
                    <div class="raffle-info-item">
                        <i class="fas fa-ticket-alt"></i>
                        <div>
                            <span class="info-label">Valor Boleto</span>
                            <span class="info-value">$. {{ rifa.precio|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prizes Section -->
            {% if rifa.images.all %}
            <div class="purchase-section">
                <h3 class="section-subtitle">
                    <i class="fas fa-gift"></i> Premios
                </h3>
                <div class="prizes-carousel">
                    <div class="carousel-wrapper">
                        {% for img in rifa.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ img.image.url }}" alt="Premio {{ forloop.counter }}" class="prize-image">
                        </div>
                        {% endfor %}
                    </div>
                    {% if rifa.images.count > 1 %}
                    <button type="button" class="carousel-btn prev-btn" onclick="changePrizeSlide(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="carousel-btn next-btn" onclick="changePrizeSlide(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="carousel-indicators">
                        {% for img in rifa.images.all %}
                        <span class="indicator {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}"></span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Ticket Quantity Selector -->
            <div class="purchase-section">
                <h3 class="section-subtitle">
                    <i class="fas fa-ticket-alt"></i> Cantidad de Tickets
                </h3>
                <div class="ticket-selector">
                    <div class="quick-select-grid">
                        <button type="button" class="quick-select-btn" data-value="1">1</button>
                        <button type="button" class="quick-select-btn" data-value="2">2</button>
                        <button type="button" class="quick-select-btn" data-value="5">5</button>
                        <button type="button" class="quick-select-btn" data-value="10">10</button>
                        <button type="button" class="quick-select-btn" data-value="25">25</button>
                        <button type="button" class="quick-select-btn" data-value="50">50</button>
                    </div>
                    <div class="quantity-controls">
                        <button type="button" class="quantity-btn minus-btn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" name="cantidad" id="cantidadInput" class="quantity-input" value="1" min="1" max="{{ rifa.tickets_available }}" required>
                        <button type="button" class="quantity-btn plus-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="purchase-section">
                <div class="payment-summary">
                    <div class="summary-row">
                        <span>Monto a pagar ($.)</span>
                        <span id="montoBs" class="summary-value">$. {{ rifa.precio|floatformat:2 }}</span>
                        <input type="hidden" name="total" id="totalInput" value="{{ rifa.precio|floatformat:2 }}">
                    </div>
                </div>
            </div>
            
            <!-- Payment Methods -->
            <div class="purchase-section">
                <h3 class="section-subtitle">
                    <i class="fas fa-credit-card"></i> Métodos de Pago
                </h3>
                <div class="payment-methods">
                    {% for metodo in metodos_pago %}
                    <label class="payment-method-card">
                        <input type="radio" name="metodo_pago" value="{{ metodo.nombre }}" data-metodo-id="{{ metodo.id }}" {% if forloop.first %}checked{% endif %}>
                        <div class="payment-method-content">
                            <div class="payment-method-icon">
                                {% if 'Zelle' in metodo.nombre %}
                                <i class="fas fa-dollar-sign"></i>
                                {% elif 'Binance' in metodo.nombre %}
                                <i class="fab fa-bitcoin"></i>
                                {% elif 'PayPal' in metodo.nombre %}
                                <i class="fab fa-paypal"></i>
                                {% else %}
                                <i class="fas fa-university"></i>
                                {% endif %}
                            </div>
                            <span class="payment-method-name">{{ metodo.nombre }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
                <div class="summary-row">
                    <span>Seleccione un Metodo para registrar el pago</span>
                    <span id="metodoPagoText" class="summary-value">- - - - - -</span>
                </div>
                
                <!-- Payment Details -->
                <div id="paymentDetails" class="payment-details"></div>
                
                <div id="paymentCopyActions" class="copy-actions" style="display: none;">
                    <span id="copyFeedback" class="copy-feedback" style="display: none;">
                        <i class="fas fa-check"></i> Copiado
                    </span>
                </div>
            </div>

            <!-- Buyer Information -->
            <div class="purchase-section">
                <h3 class="section-subtitle">
                    <i class="fas fa-user"></i> Datos del Comprador
                </h3>
                
                <div class="form-group">
                    <label for="cedulaInput">Cédula</label>
                    <input type="number" id="cedulaInput" name="identificacion" class="form-input" placeholder="Escriba su cédula" required>
                </div>

                <div class="form-group">
                    <label for="nombreInput">Nombre completo</label>
                    <input type="text" id="nombreInput" name="nombre" class="form-input" placeholder="Escriba su nombre completo" required>
                </div>

                <div class="form-group">
                    <label for="correoInput">Correo</label>
                    <input type="email" id="correoInput" name="email" class="form-input" placeholder="Escriba su correo de uso diario" required>
                </div>

                <div class="form-group mb-3">
                    <label for="telefono">Teléfono</label>
                    <input type="number" id="telefono" name="telefono" class="form-input" value="{{ request.POST.telefono|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label for="comprobanteInput">Capture Bancario</label>
                    <input type="file" id="comprobanteInput" name="comprobante" class="form-input-file" accept="image/*" required>
                    <label for="comprobanteInput" class="file-input-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Seleccionar archivo</span>
                        <span class="file-name">Ningún archivo seleccionado</span>
                    </label>
                </div>
                <div class="form-group">
                    <label for="referenciaInput">Referencia bancaria (Últimos 6 Dígitos)</label>
                    <input type="text" id="referenciaInput" name="referencia" class="form-input"
                           placeholder="Últimos 6 dígitos de la referencia"
                           inputmode="numeric" maxlength="6" pattern="\d{6}" title="Ingrese exactamente 6 dígitos"
                           oninput="this.value = this.value.replace(/\D/g,'').slice(0,6)" required>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-submit">
                <i class="fas fa-money-bill-wave"></i> Comprar
            </button>
        </form>
    </div>

    <!-- Payment Methods Data -->
    <script id="paymentMethodsData" type="application/json">
    [
    {% for metodo in metodos_pago %}
        {
            "id": {{ metodo.id }},
            "nombre": "{{ metodo.nombre|escapejs }}",
            "detalles": "{{ metodo.detalles|default:""|escapejs }}",
            "fields": [
                {% for f in metodo.fields.all %}
                    { "field_name": "{{ f.field_name|escapejs }}", "field_value": "{{ f.field_value|escapejs }}" }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ]
    </script>

    <script src="{% static 'js/main.js' %}"></script>
    <script>
    function changePrizeSlide(direction) {
        const carousel = document.querySelector('.prizes-carousel');
        if (!carousel) return; // no carousel on page

        const items = carousel.querySelectorAll('.carousel-item');
        if (!items || items.length === 0) return;

        const indicators = carousel.querySelectorAll('.indicator');
        let currentIndex = Array.from(items).findIndex(item => item.classList.contains('active'));

        // if no active item found, default to 0
        if (currentIndex < 0) currentIndex = 0;

        // safely remove current active
        if (items[currentIndex]) items[currentIndex].classList.remove('active');
        if (indicators && indicators[currentIndex]) indicators[currentIndex].classList.remove('active');

        // compute next index
        currentIndex = (currentIndex + direction + items.length) % items.length;

        // add active to new index if exists
        if (items[currentIndex]) items[currentIndex].classList.add('active');
        if (indicators && indicators[currentIndex]) indicators[currentIndex].classList.add('active');
    }

    function goToPrizeSlide(index) {
        const carousel = document.querySelector('.prizes-carousel');
        if (!carousel) return;

        const items = carousel.querySelectorAll('.carousel-item');
        if (!items || items.length === 0) return;

        const indicators = carousel.querySelectorAll('.indicator');

        // clamp index
        let idx = parseInt(index) || 0;
        if (idx < 0) idx = 0;
        if (idx >= items.length) idx = items.length - 1;

        items.forEach(item => item.classList.remove('active'));
        if (indicators && indicators.length) indicators.forEach(ind => ind.classList.remove('active'));

        if (items[idx]) items[idx].classList.add('active');
        if (indicators && indicators[idx]) indicators[idx].classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
        window._paymentMethods = JSON.parse(document.getElementById('paymentMethodsData').textContent || '[]');
        
        const cantidadInput = document.getElementById('cantidadInput');
        const minusBtn = document.querySelector('.minus-btn');
        const plusBtn = document.querySelector('.plus-btn');
        const quickSelectBtns = document.querySelectorAll('.quick-select-btn');
        const carouselIndicators = document.querySelectorAll('.carousel-indicators .indicator');
        const paymentRadios = document.querySelectorAll('input[name="metodo_pago"]');
        const detailsDiv = document.getElementById('paymentDetails');
        const copyActions = document.getElementById('paymentCopyActions');
    // copyAllBtn removed; per-field buttons handle copying now
        const copyFeedback = document.getElementById('copyFeedback');
        const metodoPagoText = document.getElementById('metodoPagoText');
        const fileInput = document.getElementById('comprobanteInput');
    const precioRifa = parseFloat('{{ precio_rifa|default:rifa.precio|floatformat:2 }}');
    const montoBsEl = document.getElementById('montoBs');
    const totalInput = document.getElementById('totalInput');

        // Quantity controls
        minusBtn.addEventListener('click', () => {
            const current = parseInt(cantidadInput.value) || 1;
            if (current > 1) cantidadInput.value = current - 1;
            updateTotal();
        });

        plusBtn.addEventListener('click', () => {
            const current = parseInt(cantidadInput.value) || 1;
            const max = parseInt(cantidadInput.max) || 999;
            if (current < max) cantidadInput.value = current + 1;
            updateTotal();
        });

        quickSelectBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const value = parseInt(btn.dataset.value);
                const max = parseInt(cantidadInput.max) || 999;
                cantidadInput.value = Math.min(value, max);
                
                quickSelectBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateTotal();
            });
        });

        // update total display
        function updateTotal() {
            const qty = parseInt(cantidadInput.value) || 0;
            const total = (isNaN(precioRifa) ? 0 : precioRifa) * qty;
            if (montoBsEl) montoBsEl.textContent = '$. ' + total.toFixed(2);
            if (totalInput) totalInput.value = total.toFixed(2);
        }

        // recalc when typing directly in the number input
        cantidadInput.addEventListener('input', function(){ updateTotal(); });

        // ensure total is set before submit
        const purchaseForm = document.querySelector('.purchase-form');
        if (purchaseForm) {
            purchaseForm.addEventListener('submit', function(){ updateTotal(); });
        }

        // Carousel indicators (usando data-index en lugar de onclick inline)
        if (carouselIndicators && carouselIndicators.length) {
            carouselIndicators.forEach(ind => {
                ind.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index')) || 0;
                    goToPrizeSlide(idx);
                });
            });
        }

        // File input display
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const label = this.nextElementSibling;
                const fileName = label.querySelector('.file-name');
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                } else {
                    fileName.textContent = 'Ningún archivo seleccionado';
                }
            });
        }

        // Payment method selection
        // helper to escape attribute values when inserting into data-value
        function escapeHtmlAttr(s) {
            if (s === null || s === undefined) return '';
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }
        function renderDetails(metodoId) {
            const m = window._paymentMethods.find(x => String(x.id) === String(metodoId));
            if (!m) {
                detailsDiv.innerHTML = '';
                copyActions.style.display = 'none';
                metodoPagoText.textContent = '- - - - - -';
                return;
            }

            metodoPagoText.textContent = m.nombre;
            
            let html = '';
            if (m.fields && m.fields.length) {
                html += '<div class="payment-info-card">';
                m.fields.forEach((f, idx) => {
                    // show label and value, include a copy button that uses the .btn-copy style and label
                    html += '<div class="payment-info-row">'
                        + '<div class="payment-info-label">' + f.field_name + '</div>'
                        + '<div class="payment-info-value">' + f.field_value + '</div>'
                        + '<button type="button" class="copy-field-btn btn-copy" data-value="' + escapeHtmlAttr(f.field_value) + '" title="Copiar">'
                        + '<i class="fas fa-copy"></i> Copiar'
                        + '</button>'
                        + '</div>';
                });
                html += '</div>';
                copyActions.style.display = 'flex';
            } else if (m.detalles) {
                html = '<div class="payment-info-card"><p>' + m.detalles + '</p></div>';
                copyActions.style.display = 'flex';
            } else {
                html = '';
                copyActions.style.display = 'none';
            }
            
            detailsDiv.innerHTML = html;
        }

        paymentRadios.forEach(r => {
            r.addEventListener('change', function() {
                renderDetails(this.dataset.metodoId);
            });
        });

        // Initial render
        const checked = document.querySelector('input[name="metodo_pago"]:checked');
        if (checked) renderDetails(checked.dataset.metodoId);

        // copy-all removed; per-field buttons handle copying now

        // Delegate clicks on per-field copy buttons inside detailsDiv
        detailsDiv.addEventListener('click', function(e) {
            const btn = e.target.closest && e.target.closest('.copy-field-btn');
            if (!btn) return;
            const value = btn.getAttribute('data-value') || '';
            if (!value) return;
            copyToClipboard(value, function(success) {
                if (success) {
                    copyFeedback.style.display = 'inline-flex';
                    setTimeout(() => { copyFeedback.style.display = 'none'; }, 1500);
                }
            });
        });

        function copyToClipboard(text, cb) {
            if (!navigator.clipboard) {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                try {
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    cb(Boolean(ok));
                } catch (err) {
                    document.body.removeChild(ta);
                    cb(false);
                }
                return;
            }
            navigator.clipboard.writeText(text).then(() => cb(true)).catch(() => cb(false));
        }

        // Auto-rotate prizes carousel
        const prizesCarousel = document.querySelector('.prizes-carousel');
        if (prizesCarousel) {
            const items = prizesCarousel.querySelectorAll('.carousel-item');
            if (items && items.length > 1) {
                setInterval(function() {
                    changePrizeSlide(1);
                }, 5000); // Change every 5 seconds
            }
        }
    });
    </script>
</body>
</html>
