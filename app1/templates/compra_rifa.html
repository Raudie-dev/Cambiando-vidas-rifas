{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Comprar Tickets - {{ rifa.titulo }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header">
        <div class="container header-wrapper">
            <a href="{% url 'index' %}" class="logo">
                <i class="fas fa-flask-vial me-2"></i>PruebasApp
            </a>
        </div>
    </header>

    <section class="section" style="padding-top: 80px;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Comprar Tickets - {{ rifa.titulo }}</h3>
                            <p>{{ rifa.descripcion }}</p>
                            <p><strong>Sorteo:</strong> {{ rifa.fecha_sorteo }}</p>
                            <p><strong>Disponibles:</strong> {{ rifa.tickets_available }}</p>

                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="rifa_id" value="{{ rifa.id }}">
                                <div class="mb-3">
                                    <label class="form-label">Identificación</label>
                                    <input type="text" name="identificacion" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nombre completo</label>
                                    <input type="text" name="nombre" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email (opcional)</label>
                                    <input type="email" name="email" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cantidad de tickets</label>
                                    <input type="number" name="cantidad" min="1" max="{{ rifa.tickets_available }}" value="1" class="form-control" required>
                                </div>
                                <hr>
                                <h5>Método de pago</h5>
                                <div class="mb-3">
                                    {% for metodo in metodos_pago %}
                                    <div class="form-check">
                                        <input class="form-check-input payment-radio" type="radio" name="metodo_pago" id="metodo-{{ metodo.id }}" value="{{ metodo.nombre }}" {% if forloop.first %}checked{% endif %} data-metodo-id="{{ metodo.id }}">
                                        <label class="form-check-label" for="metodo-{{ metodo.id }}">{{ metodo.nombre }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="mb-3" id="paymentDetails">
                                    <!-- detalles del método seleccionado aparecerán aquí -->
                                </div>
                                <div class="mb-3 d-flex gap-2" id="paymentCopyActions" style="display:none;">
                                    
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Comprobante de pago (imagen)</label>
                                    <input type="file" name="comprobante" class="form-control" accept="image/*">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Código de referencia</label>
                                    <input type="text" name="referencia" class="form-control">
                                </div>
                                <div class="d-flex gap-2">
                                    <a href="{% url 'index' %}" class="btn btn-secondary">Volver</a>
                                    <button type="submit" class="btn btn-primary">Enviar comprobante y comprar</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('.payment-radio');
        const detailsDiv = document.getElementById('paymentDetails');
    const copyActions = document.getElementById('paymentCopyActions');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const copyFeedback = document.getElementById('copyFeedback');
        function renderDetails(metodoId) {
                // find method data in a JS object embedded below
                if (!window._paymentMethods) return;
                const m = window._paymentMethods.find(x => String(x.id) === String(metodoId));
                if (!m) {
                        detailsDiv.innerHTML = '';
            copyActions.style.display = 'none';
                        return;
                }
                // show its fields
                let html = '';
                if (m.fields && m.fields.length) {
                        html += '<div class="card p-2">';
            m.fields.forEach((f, idx) => {
                // each field has a copy button
                const safeName = String(f.field_name).replace(/"/g, '\\"');
                const safeValue = String(f.field_value).replace(/"/g, '\\"');
                html += '<div class="d-flex align-items-center justify-content-between mb-1">'
                    + '<div><strong>' + f.field_name + ':</strong> <span class="field-value" data-field-idx="' + idx + '">' + f.field_value + '</span></div>'
                    + '<div><button type="button" class="btn btn-sm btn-outline-primary copy-field" data-field-idx="' + idx + '" data-field-name="' + safeName + '" data-field-value="' + safeValue + '">Copiar</button></div>'
                    + '</div>';
            });
                        html += '</div>';
            copyActions.style.display = '';
                } else if (m.detalles) {
            html = '<div class="card p-2">' + m.detalles + '</div>';
            copyActions.style.display = '';
                } else {
                        html = '';
            copyActions.style.display = 'none';
                }
                detailsDiv.innerHTML = html;
        attachCopyHandlers();
        }
    function attachCopyHandlers() {
        // individual field copy buttons
        const buttons = document.querySelectorAll('.copy-field');
        buttons.forEach(b => {
            b.removeEventListener('click', onCopyFieldClick);
            b.addEventListener('click', onCopyFieldClick);
        });
    }
    function onCopyFieldClick(e) {
        const btn = e.currentTarget;
        const value = btn.dataset.fieldValue || '';
        copyToClipboard(value, function(success) {
            showCopyFeedback(success);
        });
    }
    function copyToClipboard(text, cb) {
        if (!navigator.clipboard) {
            // fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try {
                const ok = document.execCommand('copy');
                document.body.removeChild(ta);
                cb(Boolean(ok));
            } catch (err) {
                document.body.removeChild(ta);
                cb(false);
            }
            return;
        }
        navigator.clipboard.writeText(text).then(() => cb(true)).catch(() => cb(false));
    }
    function showCopyFeedback(success) {
        if (!success) return;
        copyFeedback.style.display = '';
        setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
    }
        radios.forEach(r => r.addEventListener('change', function() { renderDetails(this.dataset.metodoId); }));
        // initial render of first checked
        const checked = document.querySelector('.payment-radio:checked');
        if (checked) renderDetails(checked.dataset.metodoId);

    // copy all details button
    copyAllBtn.addEventListener('click', function() {
        const checked = document.querySelector('.payment-radio:checked');
        if (!checked) return;
        const m = window._paymentMethods.find(x => String(x.id) === String(checked.dataset.metodoId));
        if (!m) return;
        let text = m.nombre + '\n';
        if (m.fields && m.fields.length) {
            m.fields.forEach(f => { text += f.field_name + ': ' + f.field_value + '\n'; });
        } else if (m.detalles) {
            text += m.detalles + '\n';
        }
        copyToClipboard(text, function(success) { showCopyFeedback(success); });
    });
});
</script>

    <!-- JSON con métodos de pago para uso en cliente -->
    <script id="paymentMethodsData" type="application/json">
    [
    {% for metodo in metodos_pago %}
        {
            "id": {{ metodo.id }},
            "nombre": "{{ metodo.nombre|escapejs }}",
            "detalles": "{{ metodo.detalles|default:""|escapejs }}",
            "fields": [
                {% for f in metodo.fields.all %}
                    { "field_name": "{{ f.field_name|escapejs }}", "field_value": "{{ f.field_value|escapejs }}" }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ]
    </script>
    <script>
    window._paymentMethods = JSON.parse(document.getElementById('paymentMethodsData').textContent || '[]');
    </script>
</html>