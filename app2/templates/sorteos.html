{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras Pendientes</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/paneles-style.css' %}">
</head>
<body>
    <!-- Navbar Superior -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <button class="btn btn-outline-light me-3" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
         <img src="{% static 'images/cambiando-vidas.png' %}" alt="Logo" height="50" class="me-2">
        <div class="ms-auto d-flex align-items-center">
          <span class="text-secondary me-3 d-none d-md-inline">
            <i class="fas fa-user-circle me-2"></i>Administrador
          </span>
          <a href="{% url 'login' %}" class="btn btn-outline-light">
            <i class="fas fa-sign-out-alt"></i>
            <span class="d-none d-md-inline ms-1">Salir</span>
          </a>
        </div>
      </div>
    </nav>

    <div class="d-flex" id="wrapper" style="min-height:100vh;">
      <!-- Sidebar -->
      <div id="sidebar-wrapper">
        <div class="sidebar-heading border-bottom">
          <img src="{% static 'images/logo-img.png' %}" alt="Logo" width="80" class="mb-2">
          <h5>Sistema de Rifas</h5>
        </div>
        <div class="list-group list-group-flush">
          <a href="{% url 'control' %}" class="list-group-item">
            <i class="fas fa-gifts"></i>
            <span>Panel Rifas</span>
          </a>
          <a href="{% url 'sorteos' %}" class="list-group-item active">
            <i class="fas fa-dice fa-fw"></i>
            <span>Sorteos</span>
          </a>
          <a href="{% url 'compras' %}" class="list-group-item">
            <i class="fas fa-shopping-cart"></i>
            <span>Compras pendientes</span>
          </a>
          <a href="{% url 'historial_compras' %}" class="list-group-item">
            <i class="fas fa-history"></i>
            <span>Historial Compras</span>
          </a>
        </div>
      </div>

      <!-- Contenido principal -->
      <div class="flex-grow-1" id="page-content-wrapper">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}

        <!-- Header de la página -->
        <div class="mb-4">
      <h2 class="mb-1">
        <i class="fas fa-dice me-2 text-gradient"></i>Sorteos
      </h2>
      <p class="text-secondary mb-0">Lista de rifas y accesos para ejecutar el sorteo (manual).</p>
        </div>

        <!-- Filter by Rifa -->
        <div class="mb-3">
          <form method="get" id="filterForm">
            <div class="row g-2 align-items-center">
              <div class="col-auto">
                <label class="form-label mb-0">Filtrar por Rifa:</label>
              </div>
              <div class="col-auto">
                <select name="rifa_id" id="rifaFilter" class="form-select form-select-sm">
                  <option value="">-- Todas --</option>
                  {% for r in rifas %}
                    <option value="{{ r.id }}" {% if selected_rifa and selected_rifa|stringformat:"s" == r.id|stringformat:"s" %}selected{% endif %}>{{ r.titulo }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </form>
        </div>

        <!-- Card de Sorteos (lista) -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Rifas</h5>
            <a href="{% url 'control' %}" class="btn btn-sm btn-outline-secondary">Volver al panel</a>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Título</th>
                    <th>Fecha</th>
                    <th>Vendidos</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th>Ganador</th>
                    <th>N° Ticket</th>
                    <th>Teléfono</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in rifas %}
                  <tr>
                    <td class="fw-semibold">{{ r.titulo }}</td>
                    <td>{{ r.fecha_sorteo }}</td>
                    <td>{{ r.tickets_sold }} / {{ r.total_tickets }}</td>
                    <td>Bs. {{ r.precio|floatformat:2 }}</td>
                    <td>
                      {% if r.can_draw %}
                        <span class="badge bg-success">Puede sortear hoy</span>
                      {% else %}
                        <span class="badge bg-secondary">Programado</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if r.winner %}
                        {{ r.winner.nombre }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if r.winner %}
                        {{ r.winner.number }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if r.winner and r.winner.telefono %}
                        <span class="text-success">{{ r.winner.telefono }}</span>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
          <button type="button" class="btn btn-sm btn-primary open-sorteo-btn" 
            data-id="{{ r.id }}" data-titulo="{{ r.titulo|escapejs }}" 
            data-fecha="{{ r.fecha_sorteo }}" data-tickets-sold="{{ r.tickets_sold }}" 
            data-precio="{{ r.precio|floatformat:2 }}" data-can-draw="{% if r.can_draw %}1{% else %}0{% endif %}" data-winner-phone="{{ r.winner.telefono|default:'' }}">
                        Abrir Sorteo
                      </button>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="9" class="text-center py-4">No hay rifas registradas.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Modales para comprobantes -->
        {% for c in compras %}
          {% if c.comprobante %}
          <div class="modal fade" id="compModal{{ c.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="fas fa-receipt me-2"></i>Comprobante - Compra #{{ c.id }}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                  <div class="mb-3">
                    <div class="row g-2 text-start">
                        <div class="col-md-6">
                            <small class="text-muted d-block">Participante</small>
                            <strong>{{ c.participante.nombre }}</strong>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block">Método de Pago</small>
                            <strong>{{ c.metodo_pago }}</strong>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block">Cantidad</small>
                            <strong>{{ c.cantidad }} tickets</strong>
                        </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Monto</small>
              <strong>Bs. {{ c.monto|floatformat:2 }}</strong>
            </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block">Referencia</small>
                            <strong>{{ c.referencia }}</strong>
                        </div>
                    </div>
                  </div>
                  <div class="border rounded p-2" style="background-color: var(--dark-bg);">
                    <img src="{{ c.comprobante.url }}" alt="Comprobante" class="img-fluid rounded" style="max-height: 500px;">
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        {% endfor %}

        <!-- Modal: Sorteo inline (reused for any rifa) -->
        <div class="modal fade" id="sorteoInlineModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="sorteoInlineTitle">Opciones de Sorteo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                <div id="sorteoInlineBody">
                  <p><strong>Rifa:</strong> <span id="sorteo_rifa_titulo"></span></p>
                  <p><strong>Fecha:</strong> <span id="sorteo_rifa_fecha"></span></p>
                  <p><strong>Tickets vendidos:</strong> <span id="sorteo_rifa_vendidos"></span></p>
                  <p><strong>Precio:</strong> Bs. <span id="sorteo_rifa_precio"></span></p>
                  <div id="sorteo_warning" class="alert alert-warning d-none">El sorteo solo puede ejecutarse en la fecha programada.</div>
                  
                  <!-- Nueva sección para asignación manual -->
                  <div class="border-top pt-3 mt-3">
                    <h6 class="mb-3"><i class="fas fa-edit me-2"></i>Asignar Ganador Manualmente</h6>
                    <div class="row g-2 align-items-end">
                      <div class="col-md-6">
                        <label for="ticketNumberInput" class="form-label small">Número de Ticket</label>
                        <input type="text" class="form-control" id="ticketNumberInput" placeholder="Ej: 25">
                      </div>
                      <div class="col-md-6">
                        <button type="button" id="asignarGanadorBtn" class="btn btn-warning w-100">
                          <i class="fas fa-user-check me-1"></i>Asignar Ganador
                        </button>
                      </div>
                    </div>
                    <div class="form-text">
                      Ingresa el número del ticket que deseas asignar como ganador.
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <form id="sorteoInlineForm" method="post" class="d-inline" action="">
                  {% csrf_token %}
                  <input type="hidden" name="do_draw" value="1">
                  <input type="hidden" name="force" id="sorteo_force" value="0">
                  <button type="submit" id="sorteoDoBtn" class="btn btn-primary">Realizar sorteo automático</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Modal: Winner epic display -->
        <div class="modal fade" id="winnerModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content text-center p-4">
              <div class="modal-body">
                <h2 class="display-5 text-success mb-3">¡Tenemos un ganador!</h2>
                <p id="winnerModalRifa" class="h5"></p>
                <p id="winnerModalTicket" class="fs-4 fw-bold"></p>
                <div id="winnerModalPhoneBlock" class="mb-2">
                  <span id="winnerModalPhone" class="fs-6 text-muted text-success"></span>
                  <span id="winnerModalPhoneActions" class="ms-2"></span>
                </div>
                <div class="mt-4">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar Toggle
    var sidebarToggle = document.getElementById('sidebarToggle');
    var wrapper = document.getElementById('wrapper');
    if (sidebarToggle && wrapper) {
        sidebarToggle.addEventListener('click', function() {
            wrapper.classList.toggle('toggled');
        });
    }

  var rifaFilter = document.getElementById('rifaFilter');
  if (rifaFilter) {
    rifaFilter.addEventListener('change', function(){
      var f = document.getElementById('filterForm');
      if (f) f.submit();
    });
  }

  // Sorteo inline modal handling
  var openBtns = document.querySelectorAll('.open-sorteo-btn');
  var sorteoModalEl = document.getElementById('sorteoInlineModal');
  var sorteoModal = sorteoModalEl ? new bootstrap.Modal(sorteoModalEl) : null;
  var titleEl = document.getElementById('sorteoInlineTitle');
  var tituloSpan = document.getElementById('sorteo_rifa_titulo');
  var fechaSpan = document.getElementById('sorteo_rifa_fecha');
  var vendidosSpan = document.getElementById('sorteo_rifa_vendidos');
  var precioSpan = document.getElementById('sorteo_rifa_precio');
  var warningEl = document.getElementById('sorteo_warning');
  var formEl = document.getElementById('sorteoInlineForm');
  var forceInput = document.getElementById('sorteo_force');

  openBtns.forEach(function(b){
    b.addEventListener('click', function(){
      var id = this.dataset.id;
      var titulo = this.dataset.titulo || '';
      var fecha = this.dataset.fecha || '';
  var vendidos = this.dataset.ticketsSold || '0';
  var precio = this.dataset.precio || '0.00';
  var canDraw = this.dataset.canDraw === '1';

      if (titleEl) titleEl.textContent = 'Opciones de Sorteo - ' + titulo;
      if (tituloSpan) tituloSpan.textContent = titulo;
      if (fechaSpan) fechaSpan.textContent = fecha;
      if (vendidosSpan) vendidosSpan.textContent = vendidos;
      if (precioSpan) precioSpan.textContent = precio;

      if (warningEl) {
        if (canDraw) {
          warningEl.classList.add('d-none');
        } else {
          warningEl.classList.remove('d-none');
          warningEl.textContent = 'El sorteo solo puede ejecutarse en la fecha programada.';
        }
      }

      // disable submit if no tickets sold or cannot draw today
      var doBtn = document.getElementById('sorteoDoBtn');
      var soldCount = parseInt(vendidos, 10) || 0;
      if (doBtn) {
        if (!canDraw || soldCount <= 0) {
          doBtn.disabled = true;
        } else {
          doBtn.disabled = false;
        }
      }

      // set form action to existing sorteo URL
      if (formEl) {
        formEl.action = '{% url "sorteo" 0 %}'.replace('/0/', '/' + id + '/');
        // reset force
        if (forceInput) forceInput.value = '0';
      }

      if (sorteoModal) sorteoModal.show();
    });
  });

  // Intercept the inline form submit to perform AJAX draw
  if (formEl) {
    formEl.addEventListener('submit', function(e){
      e.preventDefault();
      var action = formEl.action;
      var formData = new FormData(formEl);
      // send AJAX
      fetch(action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      }).then(function(resp){
        return resp.json();
      }).then(function(data){
        if (!data || !data.ok) {
          alert(data && data.message ? data.message : 'Error inesperado al realizar el sorteo');
          return;
        }
        // update the table row for rifa
        var rifaId = String(data.rifa_id || '');
        var btn = document.querySelector('.open-sorteo-btn[data-id="' + rifaId + '"]');
        if (btn) {
          var row = btn.closest('tr');
          if (row) {
            // update winner cell (6th column) including phone if provided
            var winnerCell = row.querySelector('td:nth-child(6)');
            if (winnerCell) {
              var phoneHtml = '';
              if (data.winner && data.winner.telefono) {
                phoneHtml = '<br><small class="text-muted">Tel: ' + (data.winner.telefono || '') + '</small>';
              }
              winnerCell.innerHTML = (data.winner_text || ('Ticket #' + (data.winner ? data.winner.id : ''))) + phoneHtml;
            }
            // also update the data-winner-phone attribute on the open button so future opens have it
            try { btn.setAttribute('data-winner-phone', (data.winner && data.winner.telefono) ? data.winner.telefono : ''); } catch(e){}
          }
        }

        // close inline modal
        if (sorteoModal) sorteoModal.hide();

        // show epic winner modal
        try {
          var wModalEl = document.getElementById('winnerModal');
          if (wModalEl) {
            var wModal = new bootstrap.Modal(wModalEl);
            var rifaEl = document.getElementById('winnerModalRifa');
            var ticketEl = document.getElementById('winnerModalTicket');
            var phoneEl = document.getElementById('winnerModalPhone');
            var wActions = document.getElementById('winnerModalPhoneActions');
            var rifaTitle = row ? (row.querySelector('td:first-child') ? row.querySelector('td:first-child').textContent.trim() : '') : '';
            if (rifaEl) rifaEl.textContent = rifaTitle;
            if (ticketEl) ticketEl.textContent = data.winner_text || ('Ticket #' + data.winner.id + ' — ' + data.winner.nombre);
            if (phoneEl) phoneEl.textContent = data.winner && data.winner.telefono ? ('Tel: ' + data.winner.telefono) : '';
            // populate modal copy action
            if (wActions) {
              wActions.innerHTML = '';
              if (data.winner && data.winner.telefono) {
                var btnCopy = document.createElement('button');
                btnCopy.type = 'button';
                btnCopy.className = 'btn btn-sm btn-outline-secondary ms-1';
                btnCopy.textContent = 'Copiar teléfono';
                btnCopy.addEventListener('click', function(){ copyToClipboard(data.winner.telefono); });
                wActions.appendChild(btnCopy);
              }
            }
            wModal.show();
          }
        } catch(e) { console.warn('No se pudo mostrar modal ganador', e); }
      }).catch(function(err){
        console.error(err);
        alert('Error al conectar con el servidor')
      });
    });
  }

  // If URL contains ?open=<id> open that rifa's modal automatically
  try {
    var params = new URLSearchParams(window.location.search);
    var openId = params.get('open');
    if (openId) {
      var targetBtn = document.querySelector('.open-sorteo-btn[data-id="' + openId + '"]');
      if (targetBtn) {
        // ensure modal is opened after a short delay so DOM is fully ready
        setTimeout(function(){ 
          targetBtn.click(); 
          // if a winner param exists, show the winner modal after draw
          try {
            var winnerId = params.get('winner');
            if (winnerId) {
              // find the winner text in the same row
              var row = document.querySelector('button.open-sorteo-btn[data-id="' + openId + '"]').closest('tr');
              var winnerCell = row ? row.querySelector('td:nth-child(6)') : null;
              var winnerText = winnerCell ? winnerCell.textContent.trim() : '';
              var rifaTitle = row ? (row.querySelector('td:first-child') ? row.querySelector('td:first-child').textContent.trim() : '') : '';
              setTimeout(function(){
                var wModalEl = document.getElementById('winnerModal');
                if (wModalEl) {
                  var wModal = new bootstrap.Modal(wModalEl);
                  var rifaEl = document.getElementById('winnerModalRifa');
                  var ticketEl = document.getElementById('winnerModalTicket');
                  var phoneEl = document.getElementById('winnerModalPhone');
                  if (rifaEl) rifaEl.textContent = rifaTitle;
                  if (ticketEl) ticketEl.textContent = winnerText || ('Ticket ganador: ' + winnerId);
                  // try to see if we can extract phone from the winner cell text (basic parse)
                  if (phoneEl) {
                    // If the row has a data-winner-phone on the open button, use it
                    var openBtn = document.querySelector('.open-sorteo-btn[data-id="' + openId + '"]');
                    var phoneFromBtn = openBtn ? openBtn.getAttribute('data-winner-phone') : null;
                    if (phoneFromBtn) {
                      phoneEl.textContent = 'Tel: ' + phoneFromBtn;
                      // add copy button when opening existing winner
                      try {
                        var wActions = document.getElementById('winnerModalPhoneActions');
                        if (wActions) wActions.innerHTML = '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="(function(){navigator.clipboard && navigator.clipboard.writeText(\'' + (phoneFromBtn || '') + '\')})();">Copiar teléfono</button>';
                      } catch(e) {}
                    } else {
                      // fallback: try extracting after '—' in winnerText
                      var parts = (winnerText || '').split('—');
                      if (parts.length > 1) {
                        // no phone available, leave empty
                        phoneEl.textContent = '';
                      } else {
                        phoneEl.textContent = '';
                      }
                    }
                  }
                  wModal.show();
                }
              }, 250);
            }
          } catch(e) { /* ignore */ }
        }, 100);
      }
    }
  } catch(e) { /* ignore URL parsing errors */ }

  // Asignación manual de ganador
var asignarGanadorBtn = document.getElementById('asignarGanadorBtn');
var ticketNumberInput = document.getElementById('ticketNumberInput');

if (asignarGanadorBtn && ticketNumberInput) {
  asignarGanadorBtn.addEventListener('click', function() {
    var ticketNumber = ticketNumberInput.value.trim();
    if (!ticketNumber) {
      alert('Por favor ingresa un número de ticket');
      return;
    }

    var currentRifaId = null;
    var formEl = document.getElementById('sorteoInlineForm');
    if (formEl) {
      // Extraer el rifa_id de la acción del formulario
      var action = formEl.action;
      var match = action.match(/\/sorteo\/(\d+)\//);
      if (match && match[1]) {
        currentRifaId = match[1];
      }
    }

    if (!currentRifaId) {
      alert('No se pudo identificar la rifa');
      return;
    }

    // Deshabilitar botón temporalmente
    var originalText = asignarGanadorBtn.innerHTML;
    asignarGanadorBtn.disabled = true;
    asignarGanadorBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Asignando...';

    // Enviar solicitud AJAX
    fetch('{% url "asignar_ganador" 0 %}'.replace('/0/', '/' + currentRifaId + '/'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: 'ticket_number=' + encodeURIComponent(ticketNumber)
    })
    .then(function(resp) {
      return resp.json();
    })
    .then(function(data) {
      // Restaurar botón
      asignarGanadorBtn.disabled = false;
      asignarGanadorBtn.innerHTML = originalText;

      if (!data || !data.ok) {
        alert(data && data.message ? data.message : 'Error al asignar ganador');
        return;
      }

      // Actualizar la tabla
      var rifaId = String(data.rifa_id || '');
      var btn = document.querySelector('.open-sorteo-btn[data-id="' + rifaId + '"]');
      if (btn) {
        var row = btn.closest('tr');
        if (row) {
          // Actualizar celda de ganador (columna 6)
          var winnerCell = row.querySelector('td:nth-child(6)');
          if (winnerCell) {
            var phoneHtml = '';
            if (data.winner && data.winner.telefono) {
              phoneHtml = '<br><small class="text-muted">Tel: ' + (data.winner.telefono || '') + '</small>';
            }
            winnerCell.innerHTML = (data.winner_text || ('Ticket #' + (data.winner ? data.winner.id : ''))) + phoneHtml;
          }
          
          // Actualizar celda de número de ticket (columna 7)
          var ticketCell = row.querySelector('td:nth-child(7)');
          if (ticketCell && data.winner) {
            ticketCell.innerHTML = data.winner.number || '';
          }
          
          // Actualizar celda de teléfono (columna 8)
          var phoneCell = row.querySelector('td:nth-child(8)');
          if (phoneCell && data.winner && data.winner.telefono) {
            phoneCell.innerHTML = '<span class="text-success">' + data.winner.telefono + '</span>';
          }
          
          // Actualizar atributo en el botón
          try { 
            btn.setAttribute('data-winner-phone', (data.winner && data.winner.telefono) ? data.winner.telefono : ''); 
          } catch(e){}
        }
      }

      // Cerrar modal inline
      if (sorteoModal) sorteoModal.hide();

      // Mostrar modal de ganador
      try {
        var wModalEl = document.getElementById('winnerModal');
        if (wModalEl) {
          var wModal = new bootstrap.Modal(wModalEl);
          var rifaEl = document.getElementById('winnerModalRifa');
          var ticketEl = document.getElementById('winnerModalTicket');
          var phoneEl = document.getElementById('winnerModalPhone');
          var wActions = document.getElementById('winnerModalPhoneActions');
          var rifaTitle = row ? (row.querySelector('td:first-child') ? row.querySelector('td:first-child').textContent.trim() : '') : '';
          if (rifaEl) rifaEl.textContent = rifaTitle;
          if (ticketEl) ticketEl.textContent = data.winner_text || ('Ticket #' + data.winner.number + ' — ' + data.winner.nombre);
          if (phoneEl) phoneEl.textContent = data.winner && data.winner.telefono ? ('Tel: ' + data.winner.telefono) : '';
          
          // Agregar botón de copiar teléfono
          if (wActions) {
            wActions.innerHTML = '';
            if (data.winner && data.winner.telefono) {
              var btnCopy = document.createElement('button');
              btnCopy.type = 'button';
              btnCopy.className = 'btn btn-sm btn-outline-secondary ms-1';
              btnCopy.textContent = 'Copiar teléfono';
              btnCopy.addEventListener('click', function(){ copyToClipboard(data.winner.telefono); });
              wActions.appendChild(btnCopy);
            }
          }
          wModal.show();
        }
      } catch(e) { 
        console.warn('No se pudo mostrar modal ganador', e); 
      }

      // Limpiar input
      ticketNumberInput.value = '';
      
    })
    .catch(function(err) {
      console.error(err);
      // Restaurar botón
      asignarGanadorBtn.disabled = false;
      asignarGanadorBtn.innerHTML = originalText;
      alert('Error de conexión al asignar ganador');
    });
  });

  // Permitir presionar Enter en el input
  ticketNumberInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      asignarGanadorBtn.click();
    }
  });
}
  // table copy buttons
  try {
    document.querySelectorAll('.btn-copy-phone').forEach(function(b){
      b.addEventListener('click', function(){
        var phone = this.getAttribute('data-phone') || '';
        if (phone) copyToClipboard(phone);
      });
    });
  } catch(e) {}

  // clipboard helpers
  function copyToClipboard(text) {
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function(){
        alert('Teléfono copiado: ' + text);
      }, function(){
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text) {
    try {
      var ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      alert('Teléfono copiado: ' + text);
    } catch(e) {
      alert('No se pudo copiar teléfono');
    }
  }
});
</script>
</body>
</html>